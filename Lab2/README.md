# 075: Computer Architecture - Assignment 2

Ανδρέας Γούλας (9061), Κωνσταντίνος Δουμανίδης (9263)

## Βήμα 1ο

### L1 Instruction Cache

Παράμετρος     |Τιμή
---------------|------
Μέγεθος        |32768B
Συσχέτιση      |2-way
Μέγεθος Γραμμής|64B

### L1 Data Cache

Παράμετρος     |Τιμή
---------------|------
Μέγεθος        |65536B
Συσχέτιση      |2-way
Μέγεθος Γραμμής|64B

### L2 Cache

Παράμετρος     |Τιμή
---------------|--------
Μέγεθος        |2097152B
Συσχέτιση      |8-way
Μέγεθος Γραμμής|64B

### 2GHz

Benchmark|Χρόνος   |CPI      |L1 DCache|L1 ICache|L2 Cache
---------|---------|---------|---------|---------|--------
bzip     |83.982ms |1.679650 |0.014798 |0.000077 |0.282163
mcf      |64.955ms |1.299095 |0.002108 |0.023612 |0.055046
hmmer    |59.396ms |1.187917 |0.001637 |0.000221 |0.077760
sjeng    |513.528ms|10.270554|0.121831 |0.000020 |0.999972
libm     |174.671ms|3.493415 |0.060972 |0.000094 |0.999944

### 1GHz

Benchmark|Χρόνος   |CPI     |L1 DCache|L1 ICache|L2 Cache
---------|---------|--------|---------|---------|--------
bzip     |161.025ms|1.610247|0.014675 |0.000077 |0.282157
mcf      |127.942ms|1.279422|0.002108 |0.023627 |0.055046
hmmer    |118.530ms|1.185304|0.001629 |0.000221 |0.077747
sjeng    |704.056ms|7.040561|0.121831 |0.000020 |0.999972
libm     |262.327ms|2.623265|0.060971 |0.000094 |0.999944

Το mcf παρουσιάζει μεγάλο miss rate στην I-Cache, ενώ τα sjeng και libm στην L2
και D-Cache.

Το system χρονίζεται και στις δύο περιπτώσεις στα 1GHz (system.clk_domain). 
Αυτό το ρολόι χρησιμοποιείται για τον συγχρονισμό όλων των εξαρτημάτων πάνω
στην motherboard. Αντίθετα, το cpu_clk_domain αναφέρεται στο ρολόι του
επεξεργαστή, το οποίο είναι κατά κανόνα πολλαπλάσιο του system clock. Αν
προσθέσουμε επιπλέον επεξεργαστές, αυτοί θα χρονίζονται σε πολλαπλάσια του
system clock.

Παρατηρούμε ότι ο διπλασιασμός της συχνότητας του ρολογίου δεν έχει ως
αποτέλεσμα τον ακριβή υποδιπλασιασμό του χρόνο εκτέλεσης. Αυτό οφείλεται στο
γεγονός ότι μεγάλο μέρος του χρόνου εκτέλεσης δαπανάται σε προσβάσεις στην
μνήμη. Η επιτάχυνση είναι μικρότερη όταν έχουμε υψηλό miss rate.

### Graphs
![Execution Time](/Lab2/img/step1_exec_time.png)
![CPI](/Lab2/img/step1_CPI.png)
![D-Cache Miss Rate](/Lab2/img/step1_dcache.png)
![I-Cache Miss Rate](/Lab2/img/step1_icache.png)
![L2 Cache Miss Rate](/Lab2/img/step1_l2.png)

## Βήμα 2ο

Δοκιμάσαμε να μεταβάλλουμε τις παρακάτω παραμέτρους.

* ### Μέγεθος Γραμμής

Benchmark|32B      |64B      |128B    |256B
---------|---------|---------|--------|--------
bzip     |1.852581 |1.67965  |1.666573|1.661958
mcf      |1.260085 |1.299095 |1.330534|1.298444
hmmer    |1.196843 |1.187917 |1.181978|1.179864
sjeng    |17.653706|10.270554|6.799471|5.175719
libm     |5.607827 |3.493415 |2.581299|1.990648

Παρατηρούμε ότι το CPI εμφανίζει γενικά μια ισχυρή συσχέτιση με το μέγεθος
γραμμής της κρυφής μνήμης, ειδικά στα sjeng και libm. Αυτό οφείλεται στο γεγονός
ότι το miss rate της L1 D-Cache μειώνεται σημαντικά με την αύξηση του μεγέθους
γραμμής. Επίσης, συγκεκριμένα για τα bzip και hmmer παρατηρούμε μια σημαντική
μείωση στο miss rate της L2. To mcf δεν εμφάνισε κάποια βελτίωση με την αύξηση
της παραμέτρου.

Βέλτιστο: 256B

![Block Size](/Lab2/img/step2_block_size.png)
![D-Cache Miss Rate](/Lab2/img/step2_block_size_dc_rate.png)
![L2 Miss Rate](/Lab2/img/step2_block_size_l2_rate.png)

* ### L2

Benchmark|1MB 8-way|1MB 16-way|2MB 8-way|2MB 16-way|4MB 8-way|4MB 16-way
---------|---------|----------|---------|----------|---------|----------
bzip     |1.71052  |1.709114  |1.67965  |1.681276  |1.653848 |1.653276
mcf      |1.30375  |1.303708  |1.299095 |1.155591  |1.155043 |1.155043
hmmer    |1.187917 |1.187917  |1.187917 |1.187777  |1.187777 |1.187777
sjeng    |10.273271|10.270504 |10.270554|10.27089  |10.265417|10.264996
libm     |3.495444 |3.495444  |3.493415 |3.493415  |3.489639 |3.489639

Η μεταβολή των παραμέτρων της L2 cache είχε μια μικρή αλλά όχι σημαντική
επίδραση στο CPI. Η αύξηση του associativity σε 16-way είχε σχεδόν μηδενική
επίδραση.

Βέλτιστο: 4MB 8-way

![L2 Miss Rate](/Lab2/img/step2_l2_rate.png)

* ### D-Cache

Benchmark|32KB 2-way|32KB 4-way|64KB 2-way|64KB 4-way|128KB 2-way|128KB 4-way
---------|----------|----------|----------|----------|-----------|----------
bzip     |1.706294  |1.693518  |1.67965   |1.663677  |1.650416   |1.64265
mcf      |1.29978   |1.299351  |1.299095  |1.298668  |1.298527   |1.298512
hmmer    |1.187917  |1.188545  |1.187917  |1.187732  |1.18617    |1.185883
sjeng    |10.27052  |10.270308 |10.270554 |10.27052  |10.27052   |10.270716
libm     |3.493825  |3.493415  |3.493415  |3.493415  |3.493415   |3.493415

Η μεταβολή των παραμέτρων της D-Cache είχε επίδραση μόνο στην απόδοση της bzip.
Η αυύξηση του associativity σε 4-way δεν βελτίωσε αισθητά την απόδοση.
Παρατηρούμε ότι όσο βελτιώνεται το miss rate της D-Cache, τόσο αυξάνεται το
miss rate στην L2 αλλά ταυτόχρονα οι προσβάσεις στην L2 γίνονται πιο σπάνια.

Βέλτιστο: 64KB 4-way

![Miss Rate](/Lab2/img/step2_dcache_rate.png)

* ### I-Cache

Benchmark|16KB 2-way|16KB 4-way|32KB 2-way|32KB 4-way|64KB 2-way|64KB 4-way|128KB 2-way
---------|----------|----------|----------|----------|----------|----------|-----------
bzip     |1.680134  |1.680147  |1.67965   |1.679834  |1.679876  |1.679802  |1.679727
mcf      |1.402316  |1.32466   |1.299095  |1.15545   |1.155606  |1.155442  |1.155442
hmmer    |1.188644  |1.18806   |1.187917  |1.187777  |1.187711  |1.187649  |1.187649
sjeng    |10.270894 |10.270913 |10.270554 |10.270653 |10.270481 |10.270653 |10.270481
libm     |3.503812  |3.493588  |3.493415  |3.493293  |3.493415  |3.493293  |3.493293

Η μεταβολή των παραμέτρων της I-Cache επηρέασε σημαντικά μόνο την mcf. Αυτό
οφείλεται στο γεγονός ότι το benchmark περιέχει έναν βρόγχο επανάληψης ο οποίος
δε χωράει ολόκληρος στην default L1 I-Cache. Η αύξηση του associativity σε
4-way δεν είχε σημαντική επίδραση στην απόδοση.

Βέλτιστο: 64KB 2-way

![I-Cache](/Lab2/img/step2_mcf_icache.png)
![I-Cache Miss Rate](/Lab2/img/step2_mcf_icache_miss.png)

## Βήμα 3ο: Συνάρτηση Κόστους

Για τη συνάρτηση κόστους χρησιμοποιήσαμε σαν πηγές υλικό από το μάθημα και
αποτελέσματα από την online αναζήτηση μας και πιστεύουμε πως η πιο κάτω βασική
εξίσωση περιγράφει ποιοτικά το κόστος που έχουμε για την υλοποίηση των
παραμέτρων των πιο πάνω συστημάτων:  

cost = (l1iSize * log2(l1iAssociativity) + l1dSize * log2(l1dAssociativity) + 0.7 * l2Size * log2(l2Associativity)) * log2(CLSize)  

Επιλέξαμε τη συνάρτηση αυτή με τα εξής κριτήρια:  
- Το κόστος κάθε επιπέδου μνήμης θα πρέπει να είναι γραμμικό σύμφωνα με το μέγεθος του, κάτι το οποίο συναντάται γενικά στις μνήμες (σκληροί δίσκοι, flash, DRAM κλπ).
- Τα χαμηλότερα επίπεδα SRAM μνήμης για ίδια χαρακτηριστικά (μέγεθος, συσχέτιση κλπ) είναι λίγο πιο φτηνά από κατασκευαστικής άποψης (διαφορετικής ποιότητας τρανζίστορ κλπ). Στη προκειμένη περίπτωση θεωρήσαμε ότι η L2 για ίδιες παραμέτρους με την L1 είναι πιο φτηνή κατά 30%.
- Η συσχέτιση (associativity) στη μνήμη αυξάνει το κόστος μιας μνήμης καθώς αυξάνει τη πολυπλοκοητα και την επιφάνεια πυριτίου που χρειάζεται. Αυτή η αύξηση δεν είναι γραμμική αλλά θα πρέπει να είναι τέτοια ώστε να αυξάνει δραστικά το κόστος για μεγαλύτερης τάξης συσχέτιση καθότι, όπως είδαμε και στο μάθημα, πέραν της 8-way associativity δεν βλέπουμε βελτίωση επιδόσεων και μόνο ανεβάζουμε το κόστος. Για αυτόν τον λόγο επιλέξαμε να χρησιμοποιήσουμε τον λογάριθμο της συσχέτισης.
- Για το μέγεθος γραμμής της κρυφής μνήμης (Cache Line Size) εφαρμόσαμε πολλαπλασιαστικά και στα δύο επίπεδα έναν λογάριθμο. Αυτό έγινε καθώς αφορά και τα δύο επίπεδα μνήμης και μια αλλαγή στο μέγεθος γραμμής ενώ ενδεχομένως μειώνει την πολυπλοκότητα στο κάθε επίπεδο μνήμης, συνοδεύεται με την εισαγωγή καθυστερήσεων στην μεταφορά και ανάγνωση δεδομένων (latency) καθώς και την απαίτηση για μεγαλύτερου μεγέθους bus που αυξάνει την συνολική πολυπλοκότητα του επεξεργαστή.

### Block Size

Block Size|32B  |64B  |128B |256B
----------|-----|-----|-----|-----
Κόστος    |22499|26998|31497|36998

#### CPI/Cost

Benchmark|32B  |64B  |128B |256B 
---------|-----|-----|-----|-----
bzip     |0.823|0.622|0.529|0.449
mcf      |0.56 |0.481|0.422|0.351
hmmer    |0.532|0.44 |0.375|0.319
sjeng    |7.846|3.804|2.159|1.399
libm     |2.492|1.294|0.82 |0.538

### L2

L2    |1MB 8-way|1MB 16-way|2MB 8-way|2MB 16-way|4MB 8-way|4MB 16-way
------|---------|----------|---------|----------|---------|---------
Κόστος|13482    |17783.4   |26385    |34986     |52189    |69393

#### CPI/Cost

Benchmark|1MB 8-way|1MB 16-way|2MB 8-way|2MB 16-way|4MB 8-way|4MB 16-way
---------|---------|----------|---------|----------|---------|----------
bzip     |1.269    |0.961     |0.637    |0.481     |0.317    |0.238 
mcf      |0.967    |0.733     |0.492    |0.33      |0.221    |0.166
hmmer    |0.881    |0.668     |0.45     |0.34      |0.228    |0.171
sjeng    |7.62     |5.775     |3.893    |2.936     |1.967    |1.479
libm     |2.593    |1.966     |1.324    |0.999     |0.669    |0.503

### D-Cache

D-Cache|32KB 2-way|32KB 4-way|64KB 2-way|64KB 4-way|128KB 2-way|128KB 4-way
-------|----------|----------|----------|----------|-----------|-----------
Κόστος |26188.8   |26380.8   |26380.8   |26764.8   |26764.8    |27532.8

#### CPI/Cost

Benchmark|32KB 2-way|32KB 4-way|64KB 2-way|64KB 4-way|128KB 2-way|128KB 4-way
---------|----------|----------|----------|----------|-----------|----------
bzip     |0.65154   |0.64195   |0.63669   |0.62159   |0.61664    |0.59662
mcf      |0.49631   |0.49254   |0.49244   |0.48521   |0.48516    |0.47162
hmmer    |0.45360   |0.45053   |0.45030   |0.44377   |0.44318    |0.43072
sjeng    |3.92172   |3.89310   |3.89319   |3.83732   |3.83732    |3.73036
libm     |1.33409   |1.32423   |1.32423   |1.30523   |1.30523    |1.26882

### I-Cache

I-Cache|16KB 2-way|16KB 4-way|32KB 2-way|32KB 4-way|64KB 2-way |64KB 4-way|128KB 2-way
-------|----------|----------|----------|----------|-----------|----------|-----------
Κόστος |26284.8   |26380.8   |26380.8   |26572.8   |26572.8    |26956.8   |26956.8

#### CPI/Cost

Benchmark|16KB 2-way|16KB 4-way|32KB 2-way|32KB 4-way|64KB 2-way|64KB 4-way|128KB 2-way
---------|----------|----------|----------|----------|----------|----------|-----------
bzip     |   0.63920|   0.63688|   0.63669|   0.63216|   0.63218|   0.62315|  0.62312
mcf      |   0.53351|   0.50213|   0.49244|   0.43482|   0.43488|   0.42863|  0.42863
hmmer    |   0.45222|   0.45035|   0.45030|   0.44699|   0.44696|   0.44057|  0.44057
sjeng    |   3.90754|   3.89333|   3.89319|   3.86510|   3.86504|   3.81004|  3.80998
libm     |   1.33302|   1.32429|   1.32423|   1.31461|   1.31466|   1.29589|  1.29589

*Σημείωση: Όλοι οι αριθμοί στους πίνακες CPI/cost είναι πολλαπλασιασμένοι επί 10^4

## Κριτική

Το εργαστήριο αυτό δεν ήταν δύσκολο όσον αφορά το τεχνικό κομμάτι - το να
τρέξουμε τα benchmarks δηλαδή. Ωστόσο χρειαζόταν να χρησιμοποιήσουμε τις γνώσεις
μας και την ποιοτική κατανόηση των παραμέτρων που καθορίζουν το σύστημα σε
συνδυασμό με μια βασική έρευνα και αξιολόγηση των αρχικών αποτελεσμάτων για το
κάθε benchmark ξεχωριστά ώστε να πετύχουμε σαν σχεδιαστές καλύτερα αποτελέσματα.
